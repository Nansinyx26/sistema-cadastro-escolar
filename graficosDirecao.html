<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèõÔ∏è Painel da Dire√ß√£o - Sistema Escolar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 50%, #2d3748 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 25px;
            padding: 30px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(255, 193, 7, 0.1) 100%);
            border-radius: 15px;
            border: 2px solid rgba(212, 175, 55, 0.3);
        }
        
        .header h1 {
            font-size: 3.5em;
            color: #d4af37;
            text-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.3em;
            color: #b0bec5;
            font-weight: 300;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .control-label {
            font-weight: 700;
            color: #d4af37;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        select {
            padding: 15px 20px;
            border: 2px solid #d4af37;
            border-radius: 12px;
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            color: #e0e0e0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        select:focus {
            outline: none;
            border-color: #ffc107;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.3);
            background: linear-gradient(135deg, #3a3a3a 0%, #4a4a4a 100%);
        }
        
        select:hover {
            border-color: #ffc107;
            transform: translateY(-2px);
        }
        
        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            color: #1a1a1a;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #ffc107 0%, #d4af37 100%);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.5);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #5ba0f2 0%, #4a90e2 100%);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.5);
        }
        
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #d4af37, #ffc107, #d4af37);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(212, 175, 55, 0.3);
            border-color: rgba(212, 175, 55, 0.5);
        }
        
        .stat-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 900;
            color: #d4af37;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1.1em;
            color: #94a3b8;
            font-weight: 600;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 40px;
        }
        
        .chart-section {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(212, 175, 55, 0.2);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            min-height: 500px;
        }
        
        .chart-title {
            color: #d4af37;
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .chart-container {
            height: 450px;
            position: relative;
        }
        
        .no-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #666;
            font-size: 20px;
            text-align: center;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            font-size: 20px;
            color: #d4af37;
        }
        
        .loading::after {
            content: '';
            width: 25px;
            height: 25px;
            border: 3px solid #d4af37;
            border-top: 3px solid transparent;
            border-radius: 50%;
            margin-left: 15px;
            animation: spin 1.2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .back-btn {
            position: fixed;
            top: 25px;
            left: 25px;
            background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        
        .back-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(67, 160, 71, 0.4);
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2.5em;
            }
            
            .controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        .overview-grid {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        
        .performance-grid {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
        }
        
        .comparison-chart {
            background: linear-gradient(135deg, #4c1d95 0%, #6b21a8 100%);
        }
        
        .trends-chart {
            background: linear-gradient(135deg, #134e4a 0%, #0f766e 100%);
        }
    </style>
</head>

<body>
    <button class="back-btn" onclick="goBack()">‚Üê Voltar</button>

    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è Painel da Dire√ß√£o</h1>
            <p>Vis√£o Completa do Desempenho Escolar - Todas as Turmas e Mat√©rias</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label class="control-label">üè´ Filtrar por Turma</label>
                <select id="classFilter" onchange="directionSystem.filterByClass(this.value)">
                    <option value="">Todas as Turmas</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">üìö Filtrar por Mat√©ria</label>
                <select id="subjectFilter" onchange="directionSystem.filterBySubject(this.value)">
                    <option value="">Todas as Mat√©rias</option>
                    <option value="matematica">üî¢ Matem√°tica</option>
                    <option value="portugues">üìù Portugu√™s</option>
                    <option value="geografia">üó∫Ô∏è Geografia</option>
                    <option value="historia">üìú Hist√≥ria</option>
                    <option value="ciencias">üî¨ Ci√™ncias</option>
                    <option value="ingles">üá∫üá∏ Ingl√™s</option>
                    <option value="educacao_fisica">‚öΩ Educa√ß√£o F√≠sica</option>
                </select>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="directionSystem.generateReports()" id="generateBtn">
                    üìä Gerar Relat√≥rios
                </button>
                <button class="btn btn-secondary" onclick="directionSystem.exportData()" id="exportBtn">
                    üìÑ Exportar Dados
                </button>
            </div>
        </div>

        <div class="stats-overview" id="statsOverview">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="totalStudents">0</div>
                <div class="stat-label">Total de Alunos</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üè´</div>
                <div class="stat-value" id="totalClasses">0</div>
                <div class="stat-label">Turmas Ativas</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-value" id="overallAverage">0.0</div>
                <div class="stat-label">M√©dia Geral</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-value" id="totalAssessments">0</div>
                <div class="stat-label">Total de Avalia√ß√µes</div>
            </div>
        </div>

        <div id="chartsContainer" class="charts-container">
            <div class="chart-section overview-grid">
                <h3 class="chart-title">üìà Vis√£o Geral do Desempenho</h3>
                <div class="loading">Carregando dados do sistema...</div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script>
        class DirectionDashboard {
            constructor() {
                this.dbName = 'StudentsDB';
                this.version = 4;
                this.db = null;
                this.allStudents = [];
                this.allNotes = [];
                this.filteredData = {
                    class: '',
                    subject: ''
                };
                this.charts = {};

                this.subjects = [
                    { id: 'matematica', name: 'Matem√°tica', icon: 'üî¢' },
                    { id: 'portugues', name: 'Portugu√™s', icon: 'üìù' },
                    { id: 'geografia', name: 'Geografia', icon: 'üó∫Ô∏è' },
                    { id: 'historia', name: 'Hist√≥ria', icon: 'üìú' },
                    { id: 'ciencias', name: 'Ci√™ncias', icon: 'üî¨' },
                    { id: 'ingles', name: 'Ingl√™s', icon: 'üá∫üá∏' },
                    { id: 'educacao_fisica', name: 'Educa√ß√£o F√≠sica', icon: '‚öΩ' }
                ];

                this.init();
            }

            async init() {
                console.log('üèõÔ∏è Inicializando Painel da Dire√ß√£o...');
                await this.initDB();
                await this.loadAllData();
                this.populateClassFilter();
                this.updateOverviewStats();
                this.generateCharts();
                console.log('‚úÖ Painel da Dire√ß√£o inicializado!');
            }

            async initDB() {
                return new Promise((resolve, reject) => {
                    console.log('üìÇ Conectando ao IndexedDB...');
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('‚úÖ Conectado ao IndexedDB com sucesso');
                        resolve();
                    };

                    request.onerror = (event) => {
                        console.error('‚ùå Erro ao conectar ao IndexedDB:', event.target.error);
                        reject(event.target.error);
                    };

                    request.onblocked = () => {
                        console.warn('‚ö†Ô∏è IndexedDB bloqueado');
                        alert('üö® Feche outras abas do sistema e recarregue a p√°gina.');
                        reject(new Error('IndexedDB bloqueado'));
                    };
                });
            }

            async loadAllData() {
                if (!this.db) return;

                try {
                    // Carregar todos os estudantes
                    const studentsTransaction = this.db.transaction(['students'], 'readonly');
                    const studentsStore = studentsTransaction.objectStore('students');
                    const studentsRequest = studentsStore.getAll();

                    studentsRequest.onsuccess = () => {
                        this.allStudents = studentsRequest.result.filter(s => s.name);
                        console.log(`üìö Carregados ${this.allStudents.length} alunos`);
                    };

                    // Carregar todas as notas
                    const notesTransaction = this.db.transaction(['notes'], 'readonly');
                    const notesStore = notesTransaction.objectStore('notes');
                    const notesRequest = notesStore.getAll();

                    notesRequest.onsuccess = () => {
                        this.allNotes = notesRequest.result.filter(n => n.grade !== null && n.grade !== '');
                        console.log(`üìù Carregadas ${this.allNotes.length} avalia√ß√µes`);
                    };

                } catch (error) {
                    console.error('‚ùå Erro ao carregar dados:', error);
                }
            }

            populateClassFilter() {
                const classFilter = document.getElementById('classFilter');
                const classes = [...new Set(this.allStudents.map(s => s.class))].sort();
                
                classFilter.innerHTML = '<option value="">Todas as Turmas</option>';
                classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = `Turma ${className}`;
                    classFilter.appendChild(option);
                });
            }

            updateOverviewStats() {
                const totalStudents = this.getFilteredStudents().length;
                const totalClasses = this.getActiveClasses().length;
                const totalAssessments = this.getFilteredNotes().length;
                const overallAverage = this.calculateOverallAverage();

                document.getElementById('totalStudents').textContent = totalStudents;
                document.getElementById('totalClasses').textContent = totalClasses;
                document.getElementById('totalAssessments').textContent = totalAssessments;
                document.getElementById('overallAverage').textContent = overallAverage.toFixed(1);

                // Colorir m√©dia geral
                const avgElement = document.getElementById('overallAverage');
                if (overallAverage >= 7) {
                    avgElement.style.color = '#4ade80'; // Verde
                } else if (overallAverage >= 5) {
                    avgElement.style.color = '#fbbf24'; // Amarelo
                } else {
                    avgElement.style.color = '#ef4444'; // Vermelho
                }
            }

            getFilteredStudents() {
                return this.allStudents.filter(student => {
                    if (this.filteredData.class && student.class !== this.filteredData.class) {
                        return false;
                    }
                    return true;
                });
            }

            getFilteredNotes() {
                return this.allNotes.filter(note => {
                    if (this.filteredData.class && note.class !== this.filteredData.class) {
                        return false;
                    }
                    if (this.filteredData.subject && note.subject !== this.filteredData.subject) {
                        return false;
                    }
                    return true;
                });
            }

            getActiveClasses() {
                const students = this.getFilteredStudents();
                return [...new Set(students.map(s => s.class))];
            }

            calculateOverallAverage() {
                const notes = this.getFilteredNotes();
                if (notes.length === 0) return 0;

                // Calcular m√©dia por aluno e por mat√©ria, depois m√©dia geral
                const studentSubjectGrades = {};
                
                notes.forEach(note => {
                    if (!studentSubjectGrades[note.studentId]) {
                        studentSubjectGrades[note.studentId] = {};
                    }
                    if (!studentSubjectGrades[note.studentId][note.subject]) {
                        studentSubjectGrades[note.studentId][note.subject] = [];
                    }
                    studentSubjectGrades[note.studentId][note.subject].push(parseFloat(note.grade));
                });

                let totalGrades = 0;
                let studentCount = 0;

                Object.keys(studentSubjectGrades).forEach(studentId => {
                    const subjects = studentSubjectGrades[studentId];
                    const subjectAverages = [];

                    Object.keys(subjects).forEach(subject => {
                        const grades = subjects[subject];
                        const subjectAvg = grades.reduce((a, b) => a + b, 0) / grades.length;
                        subjectAverages.push(subjectAvg);
                    });

                    if (subjectAverages.length > 0) {
                        const studentAvg = subjectAverages.reduce((a, b) => a + b, 0) / subjectAverages.length;
                        totalGrades += studentAvg;
                        studentCount++;
                    }
                });

                return studentCount > 0 ? totalGrades / studentCount : 0;
            }

            filterByClass(className) {
                this.filteredData.class = className;
                this.updateOverviewStats();
                this.generateCharts();
            }

            filterBySubject(subjectId) {
                this.filteredData.subject = subjectId;
                this.updateOverviewStats();
                this.generateCharts();
            }

            generateCharts() {
                // Destruir gr√°ficos anteriores
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.charts = {};

                const container = document.getElementById('chartsContainer');
                
                container.innerHTML = `
                    <div class="comparison-grid">
                        <div class="chart-section performance-grid">
                            <h3 class="chart-title">üìä Desempenho por Turma</h3>
                            <div class="chart-container">
                                <canvas id="classPerformanceChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-section comparison-chart">
                            <h3 class="chart-title">üìö Compara√ß√£o por Mat√©ria</h3>
                            <div class="chart-container">
                                <canvas id="subjectComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-section trends-chart">
                        <h3 class="chart-title">üìà Tend√™ncias de Desempenho</h3>
                        <div class="chart-container">
                            <canvas id="trendsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-section overview-grid">
                        <h3 class="chart-title">üéØ Distribui√ß√£o de Notas</h3>
                        <div class="chart-container">
                            <canvas id="gradeDistributionChart"></canvas>
                        </div>
                    </div>
                `;

                setTimeout(() => {
                    this.renderClassPerformanceChart();
                    this.renderSubjectComparisonChart();
                    this.renderTrendsChart();
                    this.renderGradeDistributionChart();
                }, 100);
            }

            renderClassPerformanceChart() {
                const ctx = document.getElementById('classPerformanceChart').getContext('2d');
                
                const classData = {};
                const students = this.getFilteredStudents();
                const notes = this.getFilteredNotes();

                // Agrupar notas por turma
                notes.forEach(note => {
                    if (!classData[note.class]) {
                        classData[note.class] = {
                            grades: [],
                            students: new Set()
                        };
                    }
                    classData[note.class].grades.push(parseFloat(note.grade));
                    classData[note.class].students.add(note.studentId);
                });

                // Calcular m√©dias por turma
                const chartData = Object.keys(classData).map(className => {
                    const data = classData[className];
                    const average = data.grades.reduce((a, b) => a + b, 0) / data.grades.length;
                    return {
                        class: className,
                        average: parseFloat(average.toFixed(1)),
                        studentCount: data.students.size,
                        assessmentCount: data.grades.length
                    };
                }).sort((a, b) => a.class.localeCompare(b.class));

                if (chartData.length === 0) {
                    ctx.fillStyle = '#666';
                    ctx.font = '18px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Nenhum dado encontrado', ctx.canvas.width/2, ctx.canvas.height/2);
                    return;
                }

                this.charts.classPerformance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.map(d => `Turma ${d.class}`),
                        datasets: [{
                            label: 'M√©dia da Turma',
                            data: chartData.map(d => d.average),
                            backgroundColor: chartData.map((d, i) => {
                                const colors = [
                                    'rgba(212, 175, 55, 0.8)',
                                    'rgba(74, 144, 226, 0.8)',
                                    'rgba(76, 175, 80, 0.8)',
                                    'rgba(255, 87, 34, 0.8)',
                                    'rgba(156, 39, 176, 0.8)',
                                    'rgba(255, 193, 7, 0.8)'
                                ];
                                return colors[i % colors.length];
                            }),
                            borderColor: chartData.map((d, i) => {
                                const colors = [
                                    '#d4af37',
                                    '#4a90e2',
                                    '#4caf50',
                                    '#ff5722',
                                    '#9c27b0',
                                    '#ffc107'
                                ];
                                return colors[i % colors.length];
                            }),
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                backgroundColor: '#1a202c',
                                borderColor: '#d4af37',
                                borderWidth: 1,
                                titleColor: '#e0e0e0',
                                bodyColor: '#e0e0e0',
                                callbacks: {
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        const data = chartData[index];
                                        return [
                                            `M√©dia: ${data.average}`,
                                            `Alunos: ${data.studentCount}`,
                                            `Avalia√ß√µes: ${data.assessmentCount}`
                                        ];
                                    }
                                }
                            },
                            legend: {
                                labels: {
                                    color: '#e0e0e0'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#e0e0e0'
                                },
                                grid: {
                                    color: '#374151'
                                }
                            },
                            y: {
                                min: 0,
                                max: 10,
                                ticks: {
                                    color: '#e0e0e0',
                                    stepSize: 1
                                },
                                grid: {
                                    color: '#374151'
                                }
                            }
                        }
                    }
                });
            }

            renderSubjectComparisonChart() {
                const ctx = document.getElementById('subjectComparisonChart').getContext('2d');
                
                const subjectData = {};
                const notes = this.getFilteredNotes();

                // Agrupar notas por mat√©ria
                notes.forEach(note => {
                    if (!subjectData[note.subject]) {
                        subjectData[note.subject] = [];
                    }
                    subjectData[note.subject].push(parseFloat(note.grade));
                });

                // Calcular m√©dias por mat√©ria
                const chartData = this.subjects.map(subject => {
                    const grades = subjectData[subject.id] || [];
                    if (grades.length === 0) return null;
                    
                    const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                    return {
                        subject: subject.name,
                        icon: subject.icon,
                        average: parseFloat(average.toFixed(1)),
                        count: grades.length
                    };
                }).filter(d => d !== null).sort((a, b) => b.average - a.average);

                if (chartData.length === 0) {
                    ctx.fillStyle = '#666';
                    ctx.font = '18px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Nenhum dado encontrado', ctx.canvas.width/2, ctx.canvas.height/2);
                    return;
                }

                this.charts.subjectComparison = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: chartData.map(d => `${d.icon} ${d.subject}`),
                        datasets: [{
                            data: chartData.map(d => d.average),
                            backgroundColor: [
                                'rgba(212, 175, 55, 0.8)',
                                'rgba(74, 144, 226, 0.8)',
                                'rgba(76, 175, 80, 0.8)',
                                'rgba(255, 87, 34, 0.8)',
                                'rgba(156, 39, 176, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(96, 125, 139, 0.8)'
                            ],
                            borderColor: [
                                '#d4af37',
                                '#4a90e2',
                                '#4caf50',
                                '#ff5722',
                                '#9c27b0',
                                '#ffc107',
                                '#607d8b'
                            ],
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                backgroundColor: '#1a202c',
                                borderColor: '#d4af37',
                                borderWidth: 1,
                                titleColor: '#e0e0e0',
                                bodyColor: '#e0e0e0',
                                callbacks: {
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        const data = chartData[index];
                                        return [
                                            `M√©dia: ${data.average}`,
                                            `Avalia√ß√µes: ${data.count}`
                                        ];
                                    }
                                }
                            },
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#e0e0e0',
                                    padding: 20,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderTrendsChart() {
                const ctx = document.getElementById('trendsChart').getContext('2d');
                
                const notes = this.getFilteredNotes();
                if (notes.length === 0) {
                    ctx.fillStyle = '#666';
                    ctx.font = '18px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Nenhum dado encontrado', ctx.canvas.width/2, ctx.canvas.height/2);
                    return;
                }

                // Agrupar notas por m√™s
                const monthlyData = {};
                notes.forEach(note => {
                    const date = new Date(note.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = [];
                    }
                    monthlyData[monthKey].push(parseFloat(note.grade));
                });

                // Calcular m√©dias mensais
                const sortedMonths = Object.keys(monthlyData).sort();
                const trendData = sortedMonths.map(month => {
                    const grades = monthlyData[month];
                    const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                    return {
                        month: month,
                        average: parseFloat(average.toFixed(1)),
                        count: grades.length
                    };
                });

                this.charts.trends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: trendData.map(d => {
                            const [year, month] = d.month.split('-');
                            return `${month}/${year}`;
                        }),
                        datasets: [{
                            label: 'M√©dia Mensal',
                            data: trendData.map(d => d.average),
                            borderColor: '#d4af37',
                            backgroundColor: 'rgba(212, 175, 55, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#d4af37',
                            pointBorderColor: '#ffc107',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                backgroundColor: '#1a202c',
                                borderColor: '#d4af37',
                                borderWidth: 1,
                                titleColor: '#e0e0e0',
                                bodyColor: '#e0e0e0',
                                callbacks: {
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        const data = trendData[index];
                                        return [
                                            `M√©dia: ${data.average}`,
                                            `Avalia√ß√µes: ${data.count}`
                                        ];
                                    }
                                }
                            },
                            legend: {
                                labels: {
                                    color: '#e0e0e0'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#e0e0e0'
                                },
                                grid: {
                                    color: '#374151'
                                }
                            },
                            y: {
                                min: 0,
                                max: 10,
                                ticks: {
                                    color: '#e0e0e0',
                                    stepSize: 1
                                },
                                grid: {
                                    color: '#374151'
                                }
                            }
                        }
                    }
                });
            }

            renderGradeDistributionChart() {
                const ctx = document.getElementById('gradeDistributionChart').getContext('2d');
                
                const notes = this.getFilteredNotes();
                if (notes.length === 0) {
                    ctx.fillStyle = '#666';
                    ctx.font = '18px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Nenhum dado encontrado', ctx.canvas.width/2, ctx.canvas.height/2);
                    return;
                }

                // Distribuir notas em faixas
                const ranges = {
                    '0-2': { min: 0, max: 2, count: 0, color: 'rgba(244, 67, 54, 0.8)' },
                    '2-4': { min: 2, max: 4, count: 0, color: 'rgba(255, 152, 0, 0.8)' },
                    '4-6': { min: 4, max: 6, count: 0, color: 'rgba(255, 235, 59, 0.8)' },
                    '6-8': { min: 6, max: 8, count: 0, color: 'rgba(139, 195, 74, 0.8)' },
                    '8-10': { min: 8, max: 10, count: 0, color: 'rgba(76, 175, 80, 0.8)' }
                };

                notes.forEach(note => {
                    const grade = parseFloat(note.grade);
                    Object.keys(ranges).forEach(range => {
                        const { min, max } = ranges[range];
                        if (grade >= min && grade < max) {
                            ranges[range].count++;
                        } else if (range === '8-10' && grade === 10) {
                            ranges[range].count++;
                        }
                    });
                });

                const distributionData = Object.keys(ranges).map(range => ({
                    range: range,
                    count: ranges[range].count,
                    percentage: ((ranges[range].count / notes.length) * 100).toFixed(1),
                    color: ranges[range].color
                }));

                this.charts.gradeDistribution = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: distributionData.map(d => `${d.range} (${d.percentage}%)`),
                        datasets: [{
                            label: 'Quantidade de Notas',
                            data: distributionData.map(d => d.count),
                            backgroundColor: distributionData.map(d => d.color),
                            borderColor: distributionData.map(d => d.color.replace('0.8', '1')),
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                backgroundColor: '#1a202c',
                                borderColor: '#d4af37',
                                borderWidth: 1,
                                titleColor: '#e0e0e0',
                                bodyColor: '#e0e0e0',
                                callbacks: {
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        const data = distributionData[index];
                                        return [
                                            `Quantidade: ${data.count}`,
                                            `Percentual: ${data.percentage}%`
                                        ];
                                    }
                                }
                            },
                            legend: {
                                labels: {
                                    color: '#e0e0e0'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#e0e0e0'
                                },
                                grid: {
                                    color: '#374151'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#e0e0e0'
                                },
                                grid: {
                                    color: '#374151'
                                }
                            }
                        }
                    }
                });
            }

            async generateReports() {
                if (this.allStudents.length === 0) {
                    alert('‚ùå N√£o h√° dados suficientes para gerar relat√≥rios.');
                    return;
                }

                const report = this.generateTextReport();
                
                // Download do relat√≥rio
                const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `relatorio-direcao-${new Date().toISOString().split('T')[0]}.txt`;
                link.click();

                alert('üìÑ Relat√≥rio da dire√ß√£o gerado com sucesso!');
            }

            generateTextReport() {
                let report = `üèõÔ∏è RELAT√ìRIO EXECUTIVO DA DIRE√á√ÉO\n`;
                report += `=============================================\n\n`;
                report += `üìÖ Data: ${new Date().toLocaleDateString('pt-BR')}\n`;
                report += `‚è∞ Hor√°rio: ${new Date().toLocaleTimeString('pt-BR')}\n\n`;

                // Estat√≠sticas gerais
                const students = this.getFilteredStudents();
                const notes = this.getFilteredNotes();
                const classes = this.getActiveClasses();
                const overallAverage = this.calculateOverallAverage();

                report += `üìä ESTAT√çSTICAS GERAIS:\n`;
                report += `‚Ä¢ Total de Alunos: ${students.length}\n`;
                report += `‚Ä¢ Turmas Ativas: ${classes.length}\n`;
                report += `‚Ä¢ Total de Avalia√ß√µes: ${notes.length}\n`;
                report += `‚Ä¢ M√©dia Geral da Escola: ${overallAverage.toFixed(1)}\n\n`;

                // Desempenho por turma
                report += `üè´ DESEMPENHO POR TURMA:\n`;
                const classStats = {};
                notes.forEach(note => {
                    if (!classStats[note.class]) {
                        classStats[note.class] = [];
                    }
                    classStats[note.class].push(parseFloat(note.grade));
                });

                Object.keys(classStats).sort().forEach(className => {
                    const grades = classStats[className];
                    const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                    const studentCount = students.filter(s => s.class === className).length;
                    
                    report += `  Turma ${className}:\n`;
                    report += `    ‚Ä¢ M√©dia: ${average.toFixed(1)}\n`;
                    report += `    ‚Ä¢ Alunos: ${studentCount}\n`;
                    report += `    ‚Ä¢ Avalia√ß√µes: ${grades.length}\n\n`;
                });

                // Desempenho por mat√©ria
                report += `üìö DESEMPENHO POR MAT√âRIA:\n`;
                const subjectStats = {};
                notes.forEach(note => {
                    if (!subjectStats[note.subject]) {
                        subjectStats[note.subject] = [];
                    }
                    subjectStats[note.subject].push(parseFloat(note.grade));
                });

                this.subjects.forEach(subject => {
                    const grades = subjectStats[subject.id];
                    if (grades && grades.length > 0) {
                        const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                        report += `  ${subject.icon} ${subject.name}:\n`;
                        report += `    ‚Ä¢ M√©dia: ${average.toFixed(1)}\n`;
                        report += `    ‚Ä¢ Avalia√ß√µes: ${grades.length}\n\n`;
                    }
                });

                // An√°lise de desempenho
                report += `üéØ AN√ÅLISE DE DESEMPENHO:\n`;
                if (overallAverage >= 7) {
                    report += `‚úÖ A escola apresenta desempenho EXCELENTE com m√©dia ${overallAverage.toFixed(1)}\n`;
                } else if (overallAverage >= 6) {
                    report += `‚ö†Ô∏è A escola apresenta desempenho BOM com m√©dia ${overallAverage.toFixed(1)}\n`;
                } else if (overallAverage >= 5) {
                    report += `üî∏ A escola apresenta desempenho REGULAR com m√©dia ${overallAverage.toFixed(1)}\n`;
                } else {
                    report += `‚ùå A escola apresenta desempenho BAIXO com m√©dia ${overallAverage.toFixed(1)}\n`;
                    report += `üìã RECOMENDA-SE: Implementar programa de recupera√ß√£o urgente\n`;
                }

                return report;
            }

            async exportData() {
                // Exportar dados em formato CSV
                let csv = 'Aluno,Turma,Materia,Tipo_Avaliacao,Descricao,Nota,Data\n';
                
                const notes = this.getFilteredNotes();
                const students = this.getFilteredStudents();
                const studentMap = {};
                students.forEach(s => {
                    studentMap[s.id] = s.name;
                });

                notes.forEach(note => {
                    const studentName = studentMap[note.studentId] || 'Desconhecido';
                    const subjectName = this.subjects.find(s => s.id === note.subject)?.name || note.subject;
                    
                    csv += `"${studentName}","${note.class}","${subjectName}","${note.type || ''}","${note.description || ''}",${note.grade},"${note.date}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `dados-direcao-${new Date().toISOString().split('T')[0]}.csv`;
                link.click();

                alert('üìä Dados exportados em CSV com sucesso!');
            }
        }

        // Fun√ß√µes globais
        let directionSystem;

        function goBack() {
            window.location.href = 'selecionar.html';
        }

        // Inicializar quando a p√°gina carregar
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üèõÔ∏è P√°gina do Painel da Dire√ß√£o carregada');
            directionSystem = new DirectionDashboard();
        });

        // Fallback para garantir inicializa√ß√£o
        if (document.readyState !== 'loading') {
            console.log('üèõÔ∏è Inicializando painel imediatamente');
            directionSystem = new DirectionDashboard();
        }
    </script>

</body>

</html>